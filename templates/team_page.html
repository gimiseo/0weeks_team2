<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WWL</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { background:#f6fbf9; }
    
    .fixed-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 35px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .wwl-label { 
        position: fixed;
        top: 10px;
        left: 16px;
        z-index: 2000;
        font-size: 30px;
        font-weight: 700;
        color: #00c32e;
        cursor: pointer;
    }
    .top-menu {
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 2000;
        display: flex;
        align-items: center;
    }
    .logout-text {
        margin-left: 8px;
        font-weight: 600;
        color: #363636;
        cursor: pointer;
    }
    .logout-text:hover {
        color: #ff3860;
    }
    .content-box {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .content-box img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .avatar-frame {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      border: 2px solid #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .2);
    }
  </style>
</head>
<body>
    <header class="fixed-header">
        <div class="wwl-label" onclick="handleWWLClick()">WeeklyWeLearned</div>
        <div class="top-menu">
            <div class="user-profile-btn" onclick="window.location.href='/my_page'" style="display: flex; align-items: center; cursor: pointer; padding: 8px 12px; background: #e8f5e8; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-right: 10px;">
                <div class="avatar-frame" style="width: 32px !important; height: 32px !important; border: 3px solid #fff !important; background-image: url('{{ '/static/profile_imgs/' + current_user.profile_img if current_user.profile_img else '/static/images/default-avatar.jpg' }}'); margin-right: 8px;"></div>
                <span style="font-size: 14px; font-weight: 500; color: #363636;">{{ current_user.nickname }}</span>
            </div>
            <span class="logout-text" onclick="window.location.href='/logout'">로그아웃</span>
        </div>
    </header>

  <!-- 메인 컨테이너 -->
  <section class="section" style="margin-top: 80px; padding-top: 1rem;">
    <div class="container">
      <!-- 뒤로가기 버튼 -->
      <div class="mb-3">
        <a href="/main_page" class="button is-small" style="background: none; border: none; box-shadow: none; padding-left: 0;">
          <span class="icon">
            <i class="fas fa-arrow-left"></i>
          </span>
          <span>뒤로가기</span>
        </a>
      </div>
      
      <!-- 팀 정보 표시 -->
      <h1 class="title is-3">{{ team.teamName }}</h1>
      <div class="subtitle is-6 mb-4">Week {{ team.week }} · {{ team.description }}</div>
      
      <!-- 좋아요 버튼 및 좋아요 수 -->
      <div class="is-flex is-align-items-center mb-4">
        <button class="button is-light is-small" onclick="handleTeamLike(this)">
          <span class="icon">
            <i class="fas fa-thumbs-up"></i>
          </span>
          <span>좋아요</span>
        </button>
        <span class="ml-2 has-text-grey is-size-7">좋아요 <span class="team-like-count">{{ team.upvote }}</span>개</span>
      </div>
      
      <!-- 팀 멤버 사진 및 이름 -->
      <div class="is-flex mb-4" style="flex-wrap: wrap; gap: 20px;">
        {% for member in team.members %}
        <div style="text-align:center; min-width: 80px;">
          <div class="avatar-frame" 
               style="background-image:url('{{ '/static/profile_imgs/' + member.profile_img if member.profile_img else '/static/images/default-avatar.jpg' }}'); width: 60px; height: 60px; margin: 0 auto; {% if member.role == 'master' %}border-color: #ff9800;{% endif %}">
          </div>
          <p class="mt-2 is-size-7 has-text-weight-medium">{{ member.nickname }}</p>
          <div style="height: 24px; display: flex; align-items: center; justify-content: center;">
            {% if member.role == 'master' %}
            <span class="tag is-small is-warning">팀장</span>
            {% elif member.role == 'admin' %}
            <span class="tag is-small is-primary">관리자</span>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      
      <!-- 액션 버튼들 -->
      <div class="mb-4">
        {% if is_member %}
        <a href="/team_post_write/{{ team.id }}" class="button is-success">
          <span class="icon is-small">
            <i class="fas fa-plus"></i>
          </span>
          <span>글 작성</span>
        </a>
        {% else %}
        <a href="/team_join/{{ team.id }}" class="button is-info">
          <span class="icon is-small">
            <i class="fas fa-user-plus"></i>
          </span>
          <span>팀 가입</span>
        </a>
        {% endif %}
      </div>
      
      <!-- 작성된 글 표시 -->
      {% if team.posts %}
        <!-- Clean template using permission flags from backend -->
        {% for post in team.posts %}
        <div class="box" style="position: relative;">
          <article class="media">
            <div class="media-content">
            <div class="content">
                <div class="mb-3">
                <div class="mb-2">
                    <span class="title is-4">{{ post.title }}</span>
                    <span class="title is-6 has-text-grey-light mx-2">-</span>
                    <span class="has-text-weight-semibold is-size-6">{{ post.author }}</span>
                </div>
                <div>
                    <span class="has-text-grey is-size-6">{{ post.createdAt.strftime('%Y-%m-%d %H:%M') if post.createdAt else '' }}</span>
                </div>
                </div>
                <div>
                {{ post.content | safe }}
                </div>
            </div>
            </div>
        </article>

          
          <!-- Action buttons positioned at top-right corner -->
          {% if post.can_edit or post.can_delete %}
          <div style="position: absolute; top: 15px; right: 15px; z-index: 10;">
            <div class="buttons">
              <!-- Edit button - only show if user can edit -->
              {% if post.can_edit %}
              <a href="/edit_post?post_id={{ post.id }}&team_id={{ team.id }}" 
                class="button is-info is-small">
                <span class="icon is-small">
                  <i class="fas fa-edit"></i>
                </span>
                <span>수정</span>
              </a>
              {% endif %}
              
              <!-- Delete button - only show if user can delete -->
              {% if post.can_delete %}
              <form method="POST" action="/delete_post" style="display: inline;">
                <input type="hidden" name="post_id" value="{{ post.id }}">
                <input type="hidden" name="team_id" value="{{ team.id }}">
                <button type="submit" class="button is-danger is-small" 
                        onclick="return confirm('정말로 이 게시글을 삭제하시겠습니까?')">
                  <span class="icon is-small">
                    <i class="fas fa-trash"></i>
                  </span>
                  <span>삭제</span>
                </button>
              </form>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
        <div class="content-box has-text-centered" style="padding: 40px;">
          <p class="has-text-grey is-size-5">아직 작성된 글이 없습니다.</p>
          {% if is_member %}
          <p class="has-text-grey">첫 번째 글을 작성해보세요!</p>
          {% else %}
          <p class="has-text-grey">팀에 가입하여 첫 번째 글을 작성해보세요!</p>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </section>

  <script>
    // WWL 라벨 클릭 처리 함수
    function handleWWLClick() {
        if (window.location.pathname === '/main_page') {
            window.location.reload();
        } else {
            window.location.href = '/main_page';
        }
    }

    function handleLike(button) {
      const likeCountSpan = button.nextElementSibling.querySelector('.like-count');
      let likeCount = parseInt(likeCountSpan.textContent, 10);
      likeCount += 1;
      likeCountSpan.textContent = likeCount;
    }

    function handleTeamLike(button) {
      const likeCountSpan = document.querySelector('.team-like-count');
      let likeCount = parseInt(likeCountSpan.textContent, 10);
      likeCount += 1;
      likeCountSpan.textContent = likeCount;
    }
  </script>
</body>
</html>